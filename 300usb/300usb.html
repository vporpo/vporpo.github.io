<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.2" />
<title></title>
<style type="text/css">
/* Sans-serif font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
div#toctitle,
span#author, span#revnumber, span#revdate, span#revremark,
div#footer {
  font-family: sans-serif;
}

/* Serif font. */
div.sectionbody {
  font-family: serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
}

div#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #dddddd;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  div#footer-badges { display: none; }
}

div#toc {
  margin-bottom: 2.5em;
}

div#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){asciidoc.footnotes();}
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  var cont = document.getElementById("content");
  var noteholder = document.getElementById("footnotes");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      // Use [\s\S] in place of . so multi-line matches work.
      // Because JavaScript has no s (dotall) regex flag.
      note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      spans[i].innerHTML =
        "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
        "' title='View footnote' class='footnote'>" + n + "</a>]";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
}

}
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_how_to_write_300_usb_flash_drives_in_less_than_1_hour">How to write 300 USB flash drives in less than 1 hour</h2>
<div class="sectionbody">
<div class="paragraph"><p><span class="image">
<img src="photo1.jpg" alt="photo1.jpg" />
</span></p></div>
<div class="sect2">
<h3 id="_the_problem">The problem</h3>
<div class="paragraph"><p>Say you are organizing a conference and you have to write the conference proceedings to 300 USB flash drives.
Given that these flash drives are usually cheap (and slow) it might take up to a minute to write 50MB of data to them.
These also usually come in tiny boxes so unpacking them and packing them requires additional time and effort.</p></div>
<div class="paragraph"><p>Doing the whole process by hands should take about 2 min for each USB drive.</p></div>
<div class="olist arabic"><div class="title">This involves:</div><ol class="arabic">
<li>
<p>
Unpacking the drive from its casing
</p>
</li>
<li>
<p>
Setting the USB file-system label
</p>
</li>
<li>
<p>
Writing the data to the drive
</p>
</li>
<li>
<p>
Verifying the contents
</p>
</li>
<li>
<p>
Re-packing it
</p>
</li>
</ol></div>
<div class="paragraph"><p>This task for 300 drives will take 2min * 300 = 600min = 10 hours !!!</p></div>
</div>
<div class="sect2">
<h3 id="_the_solution">The Solution</h3>
<div class="olist arabic"><div class="title">What if:</div><ol class="arabic">
<li>
<p>
we could automate the process so that it all happens automatically as soon as we insert the USB drive,
</p>
</li>
<li>
<p>
we could automatically check if the data has been written correclty, and
</p>
</li>
<li>
<p>
we could write 9 drives in parallel
</p>
</li>
</ol></div>
<div class="olist arabic"><div class="title">With the help of:</div><ol class="arabic">
<li>
<p>
udev rules
</p>
</li>
<li>
<p>
some bash scripting
</p>
</li>
<li>
<p>
and a USB hub
</p>
</li>
</ol></div>
<div class="paragraph"><p>you can do the whole thing by yourself in less than 1 hour (about 1min per 9 drives)</p></div>
<div class="paragraph"><p>Here is how:</p></div>
<div class="sect3">
<h4 id="_set_udev_to_run_a_script_whenever_a_flash_drive_is_plugged_in">Set udev to run a script whenever a flash drive is plugged in:</h4>
<div class="dlist"><dl>
<dt class="hdlist1">
Step 1
</dt>
<dd>
<p>
Get the vendor and product ids of the flash drives:
</p>
</dd>
</dl></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>$ lsusb
<span style="color: #990000">...</span>
Bus <span style="color: #993399">001</span> Device <span style="color: #993399">007</span><span style="color: #990000">:</span> ID 058f<span style="color: #990000">:</span><span style="color: #993399">6387</span> Some Flash Drive Corp<span style="color: #990000">.</span>
<span style="color: #990000">...</span></tt></pre></div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Step 2
</dt>
<dd>
<p>
Set the udev rule to run /root/usb_script.sh when the drive is inserted
/etc/udev/rules.d/50-usb.rules:
</p>
</dd>
</dl></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #009900">ACTION</span><span style="color: #990000">==</span><span style="color: #FF0000">"add"</span><span style="color: #990000">,</span> ATTRS{idVendor}<span style="color: #990000">==</span><span style="color: #FF0000">"058f"</span><span style="color: #990000">,</span> ATTRS{idProduct}<span style="color: #990000">==</span><span style="color: #FF0000">"6387"</span><span style="color: #990000">,</span> <span style="color: #009900">KERNEL</span><span style="color: #990000">==</span><span style="color: #FF0000">"sd?1"</span><span style="color: #990000">,</span> RUN<span style="color: #990000">+=</span><span style="color: #FF0000">"/root/usb_script.sh %k"</span>
</tt></pre></div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Step 3
</dt>
<dd>
<p>
Write the /root/usb_script.sh:
</p>
</dd>
</dl></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#!/bin/bash</span></span>
<span style="color: #009900">PATH</span><span style="color: #990000">=</span><span style="color: #009900">${PATH}</span><span style="color: #990000">:</span>/bin<span style="color: #990000">/:</span>/sbin<span style="color: #990000">/:</span>
<span style="font-style: italic"><span style="color: #9A1900"># The device name (sdb1, sdc1, ...) is given as a parameter from udev</span></span>
<span style="color: #009900">DEVNAME</span><span style="color: #990000">=</span><span style="color: #009900">${@}</span>
<span style="color: #009900">DEV</span><span style="color: #990000">=</span>/dev<span style="color: #990000">/</span><span style="color: #009900">${DEVNAME}</span>
<span style="color: #009900">COPY_FILES_FROM_DIR</span><span style="color: #990000">=</span>/root/CONF-NAME<span style="color: #990000">/</span>

<span style="font-style: italic"><span style="color: #9A1900"># Write debug output for each drive into /tmp/usb_script_dbg.sd{b,c,d,...}1</span></span>
<span style="color: #009900">DBG</span><span style="color: #990000">=</span>/tmp/usb_script_dbg<span style="color: #990000">.</span><span style="color: #009900">${DEVNAME}</span>
echo <span style="color: #FF0000">""</span> <span style="color: #990000">&gt;</span> <span style="color: #009900">${DBG}</span>

<span style="font-style: italic"><span style="color: #9A1900"># Bell notification: 1 beep = INIT, 2 beeps = DONE, 10 beeps = ERROR</span></span>
<span style="color: #009900">INIT</span><span style="color: #990000">=</span><span style="color: #993399">1</span>
<span style="color: #009900">DONE</span><span style="color: #990000">=</span><span style="color: #993399">2</span>
<span style="color: #009900">ERR</span><span style="color: #990000">=</span><span style="color: #993399">10</span>
<span style="font-weight: bold"><span style="color: #000000">alert()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">cnt</span><span style="color: #990000">=</span><span style="color: #993399">0</span>
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">max</span><span style="color: #990000">=</span><span style="color: #009900">${1}</span>
    echo <span style="color: #FF0000">"ALERT ${max}"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> <span style="color: #990000">[</span> <span style="color: #009900">${cnt}</span> -lt <span style="color: #009900">${max}</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">do</span></span>
        /bin/echo -e <span style="color: #FF0000">'</span><span style="color: #CC33CC">\a</span><span style="color: #FF0000">'</span> <span style="color: #990000">&gt;</span> /dev/console
        usleep <span style="color: #993399">200000</span>
        <span style="color: #009900">cnt</span><span style="color: #990000">=</span><span style="color: #009900">$(</span><span style="color: #990000">(</span><span style="color: #009900">${cnt}</span> <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">))</span>
    <span style="font-weight: bold"><span style="color: #0000FF">done</span></span>
}

<span style="font-style: italic"><span style="color: #9A1900"># Wrapper function that checks if tasks succeed or fail.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Debug print in ${DBG}</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Upon failure: 1. Write ERROR to DBG</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#               2. Unmount the drive</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#               3. Ring the bell to notify us that something went wrong</span></span>
<span style="font-weight: bold"><span style="color: #000000">safe_run()</span></span> {
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">time_begin</span><span style="color: #990000">=</span>`date <span style="color: #990000">+%</span>s`
    echo -n <span style="color: #FF0000">"${@}"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">eval</span></span> <span style="color: #009900">${@}</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[</span> <span style="color: #009900">$?</span> -ne <span style="color: #993399">0</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
        echo <span style="color: #FF0000">" ...ERROR !!!"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
        umount <span style="color: #009900">${DEV}</span>
        alert <span style="color: #009900">${ERR}</span>
        <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #993399">1</span>
    <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">time_end</span><span style="color: #990000">=</span>`date <span style="color: #990000">+%</span>s`
    <span style="font-weight: bold"><span style="color: #0000FF">local</span></span> <span style="color: #009900">time_taken</span><span style="color: #990000">=</span><span style="color: #009900">$(</span><span style="color: #990000">(</span><span style="color: #009900">${time_end}</span> - <span style="color: #009900">${time_begin}</span><span style="color: #990000">))</span>
    echo <span style="color: #FF0000">" ...OK ${time_taken}s"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
}

<span style="font-style: italic"><span style="color: #9A1900"># This is the main body of the script</span></span>
<span style="font-weight: bold"><span style="color: #000000">main()</span></span> {
   echo <span style="color: #FF0000">"Started on dev: ${DEV}"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
   alert <span style="color: #009900">${INIT}</span>

   <span style="font-style: italic"><span style="color: #9A1900"># The mount dir is of the form /mnt/mnt_sd{b,c,d,...}1</span></span>
   <span style="color: #009900">MNT</span><span style="color: #990000">=</span>/mnt/mnt_<span style="color: #009900">${DEVNAME}</span><span style="color: #990000">/</span>
   <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[</span> <span style="color: #990000">!</span> -d <span style="color: #009900">${MNT}</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
       safe_run mkdir -p <span style="color: #009900">${MNT}</span>
   <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
   <span style="font-style: italic"><span style="color: #9A1900"># 1. Format the drive with LABEL: CONF-NAME</span></span>
   safe_run mkfs<span style="color: #990000">.</span>vfat -n <span style="color: #FF0000">"CONF-NAME"</span> <span style="color: #009900">${DEV}</span>
   <span style="font-style: italic"><span style="color: #9A1900"># 2. Mount it</span></span>
   safe_run /bin/mount <span style="color: #009900">${DEV}</span> <span style="color: #009900">${MNT}</span>
   <span style="font-style: italic"><span style="color: #9A1900"># 3. Copy files from the source dir to the mounted dir</span></span>
   safe_run /bin/cp -r <span style="color: #009900">${COPY_FILES_FROM_DIR}</span> <span style="color: #009900">${MNT}</span>
   <span style="font-style: italic"><span style="color: #9A1900"># 4. Wait for the drive to sync</span></span>
   safe_run /bin/sync
   <span style="font-style: italic"><span style="color: #9A1900"># 5. Unmount it</span></span>
   safe_run /bin/umount <span style="color: #009900">${MNT}</span>
   <span style="font-style: italic"><span style="color: #9A1900"># 6. Re-mount it</span></span>
   safe_run /bin/mount <span style="color: #009900">${DEV}</span> <span style="color: #009900">${MNT}</span>
   <span style="font-style: italic"><span style="color: #9A1900"># 7. Check if total size is what we expect</span></span>
   <span style="color: #009900">CORRECT_SIZE</span><span style="color: #990000">=</span>`du -s <span style="color: #009900">${COPY_FILES_FROM_DIR}</span>`
   <span style="color: #009900">size</span><span style="color: #990000">=</span>`du -s <span style="color: #009900">${MNT}</span> <span style="color: #990000">|</span> egrep -o <span style="color: #990000">[</span><span style="color: #993399">0</span>-<span style="color: #993399">9</span><span style="color: #990000">]*</span>`
   <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #990000">[</span> <span style="color: #009900">${size}</span> -ne <span style="color: #009900">${CORRECT_SIZE}</span> <span style="color: #990000">];</span> <span style="font-weight: bold"><span style="color: #0000FF">then</span></span>
       echo <span style="color: #FF0000">"Wrong size found: ${size} instead of ${CORRECT_SIZE}"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
       alert <span style="color: #009900">${ERR}</span>
       safe_run umount <span style="color: #009900">${MNT}</span>
       <span style="font-weight: bold"><span style="color: #0000FF">exit</span></span> <span style="color: #993399">1</span>
   <span style="font-weight: bold"><span style="color: #0000FF">else</span></span>
       echo <span style="color: #FF0000">"Size ${size} ...OK"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
   <span style="font-weight: bold"><span style="color: #0000FF">fi</span></span>
   <span style="font-style: italic"><span style="color: #9A1900"># 8. Check the MD5 SUM, by comparing it to /tmp/md5deep.sd{b,c,..}1.md5</span></span>
   <span style="font-style: italic"><span style="color: #9A1900">#    This has been generated earlier</span></span>
   <span style="color: #009900">md5_file</span><span style="color: #990000">=</span>/tmp/md5deep<span style="color: #990000">.</span><span style="color: #009900">${DEVNAME}</span><span style="color: #990000">.</span>md5
   safe_run /bin/md5sum -c <span style="color: #009900">${md5_file}</span>

   safe_run umount <span style="color: #009900">${MNT}</span>
   alert <span style="color: #009900">${DONE}</span>
   echo <span style="color: #FF0000">"DONE!"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span>
}

<span style="color: #009900">time_begin</span><span style="color: #990000">=</span>`date <span style="color: #990000">+%</span>s`
main <span style="color: #009900">${@}</span>
<span style="color: #009900">time_end</span><span style="color: #990000">=</span>`date <span style="color: #990000">+%</span>s`
<span style="color: #009900">time_taken</span><span style="color: #990000">=</span><span style="color: #009900">$(</span><span style="color: #990000">(</span><span style="color: #009900">${time_end}</span> - <span style="color: #009900">${time_begin}</span><span style="color: #990000">))</span>
echo <span style="color: #FF0000">"Took ${time_taken} secs"</span> <span style="color: #990000">&gt;&gt;</span> <span style="color: #009900">${DBG}</span></tt></pre></div></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Step 4
</dt>
<dd>
<p>
Make it executable so that udev can run it:
</p>
</dd>
</dl></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># chmod +x /root/usb_script.sh</span></span></tt></pre></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_notes">Notes:</h3>
<div class="olist arabic"><div class="title">To check if the data has been written correctly we have 2 checks:</div><ol class="arabic">
<li>
<p>
We check the size of the data in the drive in step # 7.
</p>
</li>
<li>
<p>
We compare the md5 checksum against that of the files in the original directory (in COPY_FILES_FROM_DIR). You need as many of these checksum files as the number of drives you will write in parallel. Each one has a unique name /tmp/md5deep.sd{b,c,..}1.md5
To generate them:
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ find ${COPY_FILES_FROM_DIR} -type f -print0 | xargs -0 md5sum &gt;&gt; /tmp/md5deep.tmp.md5</tt></pre>
</div></div>
<div class="paragraph"><p>Then to create each /tmp/md5deep.sd{b,c,d,&#8230;}1.md5 you have to fix the path to match that of the path where each device will be mounted to (e.g. /mnt/mnt_sdb1/)</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_pipeline">The Pipeline</h2>
<div class="sectionbody">
<div class="olist arabic"><div class="title">Preparation</div><ol class="arabic">
<li>
<p>
Open one terminal for each device (one next to the other like tiles) and run:
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content">
<pre><tt>$ tail -f -s 1 /tmp/usb_script_dbg.sdb1 # also sdc1,sdd1,...</tt></pre>
</div></div>
<div class="olist arabic"><div class="title">Do the work</div><ol class="arabic">
<li>
<p>
Plug in the first USB drive and wait until you hear a single beep
</p>
</li>
<li>
<p>
Repeat the previous step until you have plugged in all flash drives
</p>
</li>
<li>
<p>
While the drives are being prepared, listen for Error Beeps and do some packing/unpacking
</p>
</li>
<li>
<p>
When you hear the DONE beeps, wait for all the drives to get done by checking on all terminals for the "DONE!" message. Remove the drives from the usb ports and go back to Step 1.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2014-12-07 14:53:39 GMT
</div>
</div>
</body>
</html>
